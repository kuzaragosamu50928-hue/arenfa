<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления "Женева"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --main-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent-blue: #0d6efd;
            --accent-green: #198754;
            --accent-red: #dc3545;
            --accent-yellow: #ffc107;
        }
        body {
            background-color: var(--main-bg);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .stat-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .submission-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        .submission-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }
        .photo-thumbnail {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-thumbnail:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        #photo-modal {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #modal-img {
            max-height: 90vh;
            max-width: 90vw;
        }
        .filter-btn.active {
            background-color: var(--accent-blue);
            color: white;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Модальное окно для просмотра фото -->
    <div id="photo-modal" class="fixed inset-0 z-50 items-center justify-center hidden" onclick="this.classList.add('hidden')">
        <div class="relative p-4">
            <img id="modal-img" src="" alt="Увеличенное изображение" class="rounded-lg">
            <button class="absolute top-2 right-2 text-white text-3xl font-bold">&times;</button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Панель управления "Женева"</h1>
            <p class="text-lg text-gray-500 mt-2">Центр модерации и аналитики</p>
        </header>

        <!-- Секция статистики -->
        <section id="stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-xl font-semibold text-gray-700">Ожидают модерации</h3>
                <p id="pending-count" class="text-5xl font-bold text-accent-blue mt-2">0</p>
            </div>
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-xl font-semibold text-gray-700">Активных объявлений</h3>
                <p id="active-count" class="text-5xl font-bold text-accent-green mt-2">0</p>
            </div>
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-xl font-semibold text-gray-700">Опубликовано сегодня</h3>
                <p id="today-count" class="text-5xl font-bold text-gray-800 mt-2">0</p>
            </div>
        </section>

        <!-- Секция модерации -->
        <main>
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800">Заявки на модерацию</h2>
                <!-- Фильтры -->
                <div id="filters" class="flex items-center space-x-2 flex-wrap">
                     <button onclick="filterSubmissions('all', this)" class="filter-btn active bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold text-sm">Все</button>
                     <button onclick="filterSubmissions('rent_offer_long_term', this)" class="filter-btn bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-semibold text-sm">Долгосрок</button>
                     <button onclick="filterSubmissions('rent_offer_daily', this)" class="filter-btn bg-teal-100 text-teal-700 px-4 py-2 rounded-full font-semibold text-sm">Посуточно</button>
                     <button onclick="filterSubmissions('rent_request', this)" class="filter-btn bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-semibold text-sm">Поиск</button>
                </div>
            </div>

            <div id="loading" class="text-center text-gray-500 py-10">Загрузка заявок...</div>
            <div id="no-submissions" class="hidden text-center text-gray-500 py-10 text-lg">Новых заявок нет. Можно отдохнуть! ✨</div>
            <div id="submissions-container" class="space-y-6">
                <!-- Карточки заявок будут вставлены сюда -->
            </div>
        </main>
    </div>

    <script>
        const container = document.getElementById('submissions-container');
        const loadingMessage = document.getElementById('loading');
        const noSubmissionsMessage = document.getElementById('no-submissions');
        let allSubmissions = {};

        function getBadge(type) {
            if (type === 'rent_offer_long_term') return '<span class="px-3 py-1 text-xs font-semibold text-blue-800 bg-blue-200 rounded-full">Долгосрок</span>';
            if (type === 'rent_offer_daily') return '<span class="px-3 py-1 text-xs font-semibold text-teal-800 bg-teal-200 rounded-full">Посуточно</span>';
            if (type === 'rent_request') return '<span class="px-3 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Поиск жилья</span>';
            return '';
        }

        function buildCard(id, submission) {
            const data = submission?.data || {};
            const isOffer = submission?.type?.startsWith('rent_offer');
            
            const photosHTML = isOffer && data.photos && Array.isArray(data.photos) && data.photos.length > 0
                ? `<div class="mt-4">
                       <h4 class="font-semibold mb-2 text-gray-700">Фотографии:</h4>
                       <div class="flex flex-wrap gap-2">
                           ${data.photos.map(fileId => `
                               <img src="/api/image/${fileId}" 
                                    class="photo-thumbnail rounded-md" 
                                    alt="Фотография"
                                    onerror="this.style.display='none'"
                                    onclick="showPhotoModal('/api/image/${fileId}')">
                           `).join('')}
                       </div>
                   </div>`
                : '';

            const priceSuffix = isOffer ? ((data.rent_type === 'long_term') ? '₽/мес.' : '₽/сутки') : '';
            const priceHTML = isOffer ? `<p class="text-gray-600"><strong class="text-gray-800">Цена:</strong> ${data.price || 'Не указана'} ${priceSuffix}</p>` : '';
            
            return `
                <div class="submission-card rounded-lg p-6" id="card-${id}" data-type="${submission.type}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${isOffer ? 'Сдача жилья' : 'Заявка на поиск'}</h3>
                            <p class="text-sm text-gray-500 mb-2">от @${data.author_username || 'скрыт'}</p>
                        </div>
                        ${getBadge(submission.type)}
                    </div>
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <p class="text-gray-600"><strong class="text-gray-800">Описание:</strong> ${data.description || 'Нет'}</p>
                        ${priceHTML}
                        ${isOffer ? `<p class="text-gray-600"><strong class="text-gray-800">Контакт:</strong> ${data.contact || 'Нет'}</p>` : ''}
                    </div>
                    ${photosHTML}
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="px-4 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600" onclick="handleAction('${id}', 'reject')">Отклонить</button>
                        <button class="px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600" onclick="handleAction('${id}', 'approve')">Одобрить</button>
                    </div>
                </div>`;
        }
        
        function displaySubmissions(submissions) {
            container.innerHTML = '';
            const submissionIds = Object.keys(submissions);

            if (submissionIds.length === 0) {
                noSubmissionsMessage.classList.remove('hidden');
            } else {
                noSubmissionsMessage.classList.add('hidden');
                submissionIds.forEach(id => {
                    if (submissions[id]) {
                        container.innerHTML += buildCard(id, submissions[id]);
                    }
                });
            }
        }
        
        async function fetchSubmissions() {
            try {
                const response = await fetch('/api/submissions');
                if (!response.ok) throw new Error('Network response was not ok');
                allSubmissions = await response.json();
                const currentFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                filterSubmissions(currentFilter, document.querySelector('.filter-btn.active'));

            } catch (error) {
                console.error('Ошибка при загрузке заявок:', error);
                container.innerHTML = '<p class="text-red-500 text-center">Не удалось загрузить заявки. Проверьте логи сервера.</p>';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('pending-count').textContent = stats.pending_count || 0;
                document.getElementById('active-count').textContent = stats.active_count || 0;
                document.getElementById('today-count').textContent = stats.today_count || 0;
            } catch (error) {
                console.error('Ошибка при загрузке статистики:', error);
            }
        }
        
        async function handleAction(id, action) {
            const card = document.getElementById(`card-${id}`);
            if (!card) return;
            card.style.opacity = '0.5';
            
            let payload = { id: id };
            if (action === 'reject') {
                const reason = prompt("Укажите причину отклонения (необязательно):", "");
                if (reason === null) {
                    card.style.opacity = '1';
                    return;
                }
                payload.reason = reason || 'Причина не указана.';
            }

            try {
                const response = await fetch(`/api/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'ok') {
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        card.remove();
                        fetchStats();
                        if(container.children.length === 0) {
                             noSubmissionsMessage.classList.remove('hidden');
                        }
                    }, 500);
                } else {
                    alert(`Ошибка: ${result.message || 'Неизвестная ошибка сервера'}`);
                    card.style.opacity = '1';
                }
            } catch (error) {
                console.error(`Ошибка при действии ${action}:`, error);
                alert('Произошла сетевая ошибка. Попробуйте еще раз.');
                card.style.opacity = '1';
            }
        }
        
        function showPhotoModal(src) {
            const modal = document.getElementById('photo-modal');
            const modalImg = document.getElementById('modal-img');
            if(modal && modalImg) {
                modalImg.src = src;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function filterSubmissions(type, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
             if(btnElement) {
                btnElement.classList.add('active', 'bg-blue-500', 'text-white');
                btnElement.dataset.filter = type;
             }

            const cards = document.querySelectorAll('.submission-card');
            let hasVisibleCards = false;
            cards.forEach(card => {
                if (type === 'all' || card.dataset.type === type) {
                    card.style.display = 'block';
                    hasVisibleCards = true;
                } else {
                    card.style.display = 'none';
                }
            });

            if (Object.keys(allSubmissions).length > 0) {
                 noSubmissionsMessage.style.display = hasVisibleCards ? 'none' : 'block';
            }
        }

        function init() {
            fetchStats();
            fetchSubmissions();
            setInterval(() => {
                fetchStats();
                fetchSubmissions();
            }, 30000);
        }

        init();
    </script>
</body>
</html>
